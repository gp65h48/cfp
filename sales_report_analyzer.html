<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- **ä¿®æ­£**: ç‰ˆæœ¬æ›´æ–° -->
    <title>é€²éŠ·å­˜åˆ†æå·¥å…· (A16)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active {
            border-color: #3B82F6; color: #3B82F6; background-color: #EFF6FF;
        }
        .drop-zone {
            border: 2px dashed #ccc; border-radius: 0.5rem; padding: 1.5rem;
            text-align: center; cursor: pointer; transition: background-color 0.3s, border-color 0.3s;
        }
        .drop-zone.dragover { background-color: #f0f9ff; border-color: #3b82f6; }
        details summary { list-style-type: 'â–º '; }
        details[open] summary { list-style-type: 'â–¼ '; }
        /* AI å›æ‡‰æ¨£å¼ */
        #ai-result h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #ai-result ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        #ai-result p { margin-bottom: 0.5rem; }
        #ai-result strong { color: #1f2937; }
        /* åº«å­˜å·®ç•°æ¨£å¼ */
        .stock-diff-pos { color: #15803d; /* green-700 */ }
        .stock-diff-neg { color: #b91c1c; /* red-700 */ }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">é€²éŠ·å­˜åˆ†æå·¥å…·</h1>
            <p class="text-gray-500 mt-2">è«‹åˆ†åˆ¥ä¸Šå‚³éŠ·å”®èˆ‡é€²è²¨å ±è¡¨ï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†æã€‚</p>
        </header>

        <!-- æª”æ¡ˆä¸Šå‚³å€ (æ‹†åˆ†) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- éŠ·å”®ä¸Šå‚³å€ -->
            <div>
                <label class="text-lg font-semibold text-gray-700 mb-2 block">1. ä¸Šå‚³éŠ·å”®è³‡æ–™</label>
                <div id="drop-zone-sales" class="drop-zone">
                    <p class="text-gray-600">æ‹–æ›³ã€ŒéŠ·å”®ã€æª”æ¡ˆè‡³æ­¤ï¼Œæˆ– <span class="text-blue-500 font-semibold">é»æ“Šé¸æ“‡</span></p>
                    <input type="file" id="file-input-sales" multiple accept=".xlsx, .xls, .csv" class="hidden">
                </div>
                <div id="file-list-sales" class="mt-3 text-sm text-gray-700"></div>
            </div>
            
            <!-- é€²è²¨ä¸Šå‚³å€ -->
            <div>
                <label class="text-lg font-semibold text-gray-700 mb-2 block">2. ä¸Šå‚³é€²è²¨è³‡æ–™</label>
                <div id="drop-zone-inv" class="drop-zone">
                    <p class="text-gray-600">æ‹–æ›³ã€Œé€²è²¨ã€æª”æ¡ˆè‡³æ­¤ï¼Œæˆ– <span class="text-blue-500 font-semibold">é»æ“Šé¸æ“‡</span></p>
                    <input type="file" id="file-input-inv" multiple accept=".xlsx, .xls, .csv" class="hidden">
                </div>
                <div id="file-list-inv" class="mt-3 text-sm text-gray-700"></div>
                <!-- å€‰åº«é¸æ“‡ (é è¨­éš±è—) -->
                <div id="warehouse-selection-div" class="hidden mt-3">
                    <label for="warehouse-select" class="block text-sm font-medium text-gray-700">è«‹é¸æ“‡è¦åˆ†æçš„å€‰åº«ï¼š</label>
                    <select id="warehouse-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- å€‰åº«é¸é …å°‡ç”± JS å‹•æ…‹å¡«å…¥ -->
                    </select>
                </div>
            </div>
        </div>

        <!-- è™•ç†ä¸­æç¤º -->
        <div id="loading" class="hidden text-center my-8">
            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-2 text-gray-600">æ­£åœ¨è™•ç†è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
        </div>

        <!-- çµæœé¡¯ç¤ºå€ (é è¨­éš±è—) -->
        <div id="result-section" class="hidden">
            <!-- åˆ†é æŒ‰éˆ• -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex flex-wrap space-x-6" aria-label="Tabs">
                    <button id="tab-report" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        å½™ç¸½å ±è¡¨
                    </button>
                    <button id="tab-chart-sales" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        éŠ·å”®è¶¨å‹¢
                    </button>
                    <button id="tab-chart-inv" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        é€²è²¨è¶¨å‹¢
                    </button>
                    <button id="tab-chart-net" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        é€²éŠ·å­˜åˆ†æ
                    </button>
                    <button id="tab-chart-total" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                        æ•´é«”ç‡Ÿé‹ç¸½è¦½
                    </button>
                    <button id="tab-ai" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-purple-600">
                        AI éŠ·å”®é¡§å• âœ¨
                    </button>
                    <button id="tab-stocktake" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-green-600">
                        åº«å­˜ç›¤é» ğŸ”
                    </button>
                </nav>
            </div>

            <!-- åˆ†é å…§å®¹ -->
            <div>
                <!-- å ±è¡¨åˆ†é  (Tab 1) -->
                <div id="content-report">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold text-gray-700">ç”¢å“é€²éŠ·å­˜å½™ç¸½</h2>
                        <div class="flex space-x-2 flex-shrink-0">
                            <!-- **ä¿®æ­£**: æŒ‰éˆ•æ–‡å­—æ›´æ–° -->
                            <button id="export-monthly-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition">åŒ¯å‡ºé€²éŠ·å­˜å½™ç¸½å ±è¡¨</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“è™Ÿ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“å</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†é¡</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½éŠ·è²¨é‡</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½éŠ·è²¨é¡</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½é€²è²¨é‡</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½é€²è²¨é¡</th>
                                    <!-- **ä¿®æ­£**: æ¬„ä½åç¨± -->
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é€²éŠ·åº«å­˜ (ç¸½é€² - ç¸½éŠ·)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ·¨åˆ©</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- éŠ·å”®åœ–è¡¨åˆ†é  (Tab 2) -->
                <div id="content-chart-sales" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">ç”¢å“éŠ·å”®è¶¨å‹¢ (æ”¯æ´ç–Šåœ–)</h2>
                    <p class="text-sm text-gray-500 mb-3">æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨æ»‘é¼ æ»¾è¼ªç¸®æ”¾ã€æŒ‰ä½æ‹–æ›³å¹³ç§»ã€æˆ–æ‹–æ›³é¸å–å€åŸŸä¾†æ”¾å¤§ã€‚</p>
                    <fieldset class="mb-4">
                        <legend class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡ Y è»¸ç¶­åº¦ï¼š</legend>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="flex items-center">
                                <input id="mode-amount-sales" name="chart-mode-sales" type="radio" value="amount" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-amount-sales" class="ml-2 block text-sm text-gray-900">éŠ·å”®ç¸½é¡</label>
                            </div>
                            <div class="flex items-center">
                                <input id="mode-quantity-sales" name="chart-mode-sales" type="radio" value="quantity" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-quantity-sales" class="ml-2 block text-sm text-gray-900">éŠ·å”®æ•¸é‡</label>
                            </div>
                        </div>
                    </fieldset>
                    <div class="mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-1 gap-2">
                            <label class="block text-sm font-medium text-gray-700">é¸æ“‡æ¯”è¼ƒé …ç›® (å¯é¸åˆ†é¡å½™ç¸½æˆ–å–®å“)ï¼š</label>
                            <div class="flex items-center space-x-4 flex-shrink-0">
                                <input id="select-all-categories-sales" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-categories-sales" class="ml-2 text-sm">å…¨é¸å½™ç¸½</label>
                                <input id="select-all-products-sales" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-products-sales" class="ml-2 text-sm">å…¨é¸å–®å“</label>
                            </div>
                        </div>
                        <div id="chart-item-selection-sales" class="max-h-60 overflow-y-auto border rounded-md p-3 bg-gray-50 space-y-1"></div>
                    </div>
                    <div class="relative h-[60vh] w-full"><canvas id="sales-chart-sales"></canvas></div>
                </div>
                
                <!-- é€²è²¨åœ–è¡¨åˆ†é  (Tab 3) -->
                <div id="content-chart-inv" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">ç”¢å“é€²è²¨è¶¨å‹¢ (æ”¯æ´ç–Šåœ–)</h2>
                    <p class="text-sm text-gray-500 mb-3">æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨æ»‘é¼ æ»¾è¼ªç¸®æ”¾ã€æŒ‰ä½æ‹–æ›³å¹³ç§»ã€æˆ–æ‹–æ›³é¸å–å€åŸŸä¾†æ”¾å¤§ã€‚</p>
                    <fieldset class="mb-4">
                        <legend class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡ Y è»¸ç¶­åº¦ï¼š</legend>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="flex items-center">
                                <input id="mode-amount-inv" name="chart-mode-inv" type="radio" value="amount" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-amount-inv" class="ml-2 block text-sm text-gray-900">é€²è²¨ç¸½é¡</label>
                            </div>
                            <div class="flex items-center">
                                <input id="mode-quantity-inv" name="chart-mode-inv" type="radio" value="quantity" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-quantity-inv" class="ml-2 block text-sm text-gray-900">é€²è²¨æ•¸é‡</label>
                            </div>
                        </div>
                    </fieldset>
                    <div class="mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-1 gap-2">
                            <label class="block text-sm font-medium text-gray-700">é¸æ“‡æ¯”è¼ƒé …ç›® (å¯é¸åˆ†é¡å½™ç¸½æˆ–å–®å“)ï¼š</label>
                            <div class="flex items-center space-x-4 flex-shrink-0">
                                <input id="select-all-categories-inv" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-categories-inv" class="ml-2 text-sm">å…¨é¸å½™ç¸½</label>
                                <input id="select-all-products-inv" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-products-inv" class="ml-2 text-sm">å…¨é¸å–®å“</label>
                            </div>
                        </div>
                        <div id="chart-item-selection-inv" class="max-h-60 overflow-y-auto border rounded-md p-3 bg-gray-50 space-y-1"></div>
                    </div>
                    <div class="relative h-[60vh] w-full"><canvas id="sales-chart-inv"></canvas></div>
                </div>

                <!-- é€²éŠ·å­˜åœ–è¡¨åˆ†é  (Tab 4) -->
                <div id="content-chart-net" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">é€²éŠ·å­˜æ·¨å€¼åˆ†æ (éŠ·å”® - é€²è²¨)</h2>
                    <p class="text-sm text-gray-500 mb-3">æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨æ»‘é¼ æ»¾è¼ªç¸®æ”¾ã€æŒ‰ä½æ‹–æ›³å¹³ç§»ã€æˆ–æ‹–æ›³é¸å–å€åŸŸä¾†æ”¾å¤§ã€‚</p>
                    <fieldset class="mb-4">
                        <legend class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡ Y è»¸ç¶­åº¦ï¼š</legend>
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="flex items-center">
                                <input id="mode-amount-net" name="chart-mode-net" type="radio" value="amount" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-amount-net" class="ml-2 block text-sm text-gray-900">æ·¨åˆ© (éŠ·å”®é¡ - é€²è²¨é¡)</label>
                            </div>
                            <div class="flex items-center">
                                <!-- **ä¿®æ­£**: æ¬„ä½åç¨± -->
                                <input id="mode-quantity-net" name="chart-mode-net" type="radio" value="quantity" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="mode-quantity-net" class="ml-2 block text-sm text-gray-900">é€²éŠ·åº«å­˜ (ç¸½é€² - ç¸½éŠ·)</label>
                            </div>
                        </div>
                    </fieldset>
                    <div class="mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-1 gap-2">
                            <label class="block text-sm font-medium text-gray-700">é¸æ“‡æ¯”è¼ƒé …ç›® (å¯é¸åˆ†é¡å½™ç¸½æˆ–å–®å“)ï¼š</label>
                            <div class="flex items-center space-x-4 flex-shrink-0">
                                <input id="select-all-categories-net" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-categories-net" class="ml-2 text-sm">å…¨é¸å½™ç¸½</label>
                                <input id="select-all-products-net" type="checkbox" class="h-4 w-4 text-blue-600"><label for="select-all-products-net" class="ml-2 text-sm">å…¨é¸å–®å“</label>
                            </div>
                        </div>
                        <div id="chart-item-selection-net" class="max-h-60 overflow-y-auto border rounded-md p-3 bg-gray-50 space-y-1"></div>
                    </div>
                    <div class="relative h-[60vh] w-full"><canvas id="sales-chart-net"></canvas></div>
                </div>

                <!-- ç¬¬äº”åˆ†é ï¼šæ•´é«”ç‡Ÿé‹ç¸½è¦½ -->
                <div id="content-chart-total" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">æ•´é«”ç‡Ÿé‹ç¸½è¦½</h2>
                    <p class="text-sm text-gray-500 mb-3">æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨æ»‘é¼ æ»¾è¼ªç¸®æ”¾ã€æŒ‰ä½æ‹–æ›³å¹³ç§»ã€æˆ–æ‹–æ›³é¸å–å€åŸŸä¾†æ”¾å¤§ã€‚</p>
                    <div class="relative h-[60vh] w-full"><canvas id="sales-chart-total"></canvas></div>
                </div>

                <!-- ç¬¬å…­åˆ†é  AI éŠ·å”®é¡§å• -->
                <div id="content-ai" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">AI éŠ·å”®é¡§å• âœ¨</h2>
                    <div class="mb-4 flex flex-wrap gap-3">
                        <button id="generate-ai-btn" class="px-5 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out shadow-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM18 12l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 18l-1.035.259a3.375 3.375 0 00-2.456 2.456L18 21.75l-.259-1.035a3.375 3.375 0 00-2.456-2.456L14.25 18l1.035-.259a3.375 3.375 0 002.456-2.456L18 12z" />
                            </svg>
                            ç”¢ç”Ÿç‡Ÿé‹åˆ†æå ±å‘Š
                        </button>
                    </div>
                    <div id="ai-loading" class="hidden text-center my-6">
                        <svg class="animate-spin h-6 w-6 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-gray-600">AI æ­£åœ¨åˆ†ææ‚¨çš„æ•¸æ“šä¸¦æœå°‹å¸‚å ´è¶¨å‹¢ï¼Œè«‹ç¨å€™...</p>
                    </div>
                    <div id="ai-result" class="prose max-w-none p-4 border rounded-lg bg-gray-50">
                        <p class="text-gray-500">é»æ“ŠæŒ‰éˆ•ä»¥ç”¢ç”ŸåŸºæ–¼æ‚¨ç›®å‰æ•¸æ“šçš„åˆ†æèˆ‡ç­–ç•¥å»ºè­°ã€‚</p>
                    </div>
                    <div id="ai-sources" class="mt-4 text-xs"></div>
                </div>
                
                <!-- ç¬¬ä¸ƒåˆ†é  åº«å­˜ç›¤é» -->
                <div id="content-stocktake" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">åº«å­˜ç›¤é»æ¯”å°</h2>
                    <!-- **ä¿®æ­£**: æ¬„ä½åç¨± -->
                    <p class="text-sm text-gray-500 mb-4">è«‹ä¸Šå‚³æ‚¨çš„æ‰‹å‹•ç›¤é»åº«å­˜è¡¨ (éœ€åŒ…å« 'å“å' å’Œ 'åº«å­˜æ•¸é‡' æ¬„ä½)ï¼Œç³»çµ±å°‡è‡ªå‹•æ¯”å°èˆ‡ã€Œå½™ç¸½å ±è¡¨ã€ä¸­çš„ã€Œé€²éŠ·åº«å­˜ã€å·®ç•°ï¼Œæ­¤è™•çš„ã€Œå³æ™‚åº«å­˜ã€å°‡ä½œç‚º AI åˆ†æçš„ä¾æ“šã€‚</p>
                    
                    <!-- ç›¤é»æª”æ¡ˆä¸Šå‚³å€ -->
                    <div>
                        <label class="text-lg font-semibold text-gray-700 mb-2 block">3. ä¸Šå‚³ç›¤é»è³‡æ–™</label>
                        <div id="drop-zone-stocktake" class="drop-zone">
                            <p class="text-gray-600">æ‹–æ›³ã€Œç›¤é»è¡¨ã€æª”æ¡ˆè‡³æ­¤ï¼Œæˆ– <span class="text-blue-500 font-semibold">é»æ“Šé¸æ“‡</span> (åƒ…é™å–®æª”)</p>
                            <input type="file" id="file-input-stocktake" accept=".xlsx, .xls, .csv" class="hidden">
                        </div>
                        <div id="file-list-stocktake" class="mt-3 text-sm text-gray-700"></div>
                    </div>
                    
                    <!-- å·®ç•°å ±è¡¨ -->
                    <div id="stocktake-result-div" class="hidden mt-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">åº«å­˜å·®ç•°å ±è¡¨</h3>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <!-- **ä¿®æ­£**: æ¬„ä½åç¨± -->
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“å</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é€²éŠ·åº«å­˜ (ç³»çµ±)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å³æ™‚åº«å­˜ (ç›¤é»)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å·®ç•° (ç›¤é» - ç³»çµ±)</th>
                                    </tr>
                                </thead>
                                <tbody id="stocktake-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <footer class="mt-8 pt-4 border-t border-gray-200 text-center">
            <!-- **ä¿®æ­£**: ç‰ˆæœ¬æ›´æ–° -->
            <p class="text-xs text-gray-400">A16ç‰ˆ è£½ä½œè€…ï¼šçš®å¡å” by Gemini</p>
        </footer>
    </div>

    <script>
        // DOM å…ƒç´ 
        const fileInputSales = document.getElementById('file-input-sales');
        const dropZoneSales = document.getElementById('drop-zone-sales');
        const fileListSales = document.getElementById('file-list-sales');
        const fileInputInv = document.getElementById('file-input-inv');
        const dropZoneInv = document.getElementById('drop-zone-inv');
        const fileListInv = document.getElementById('file-list-inv');
        const warehouseSelectionDiv = document.getElementById('warehouse-selection-div');
        const warehouseSelect = document.getElementById('warehouse-select');
        
        // ç›¤é» DOM
        const fileInputStocktake = document.getElementById('file-input-stocktake');
        const dropZoneStocktake = document.getElementById('drop-zone-stocktake');
        const fileListStocktake = document.getElementById('file-list-stocktake');
        const stocktakeResultDiv = document.getElementById('stocktake-result-div');
        const stocktakeTableBody = document.getElementById('stocktake-table-body');
        
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const resultSection = document.getElementById('result-section');
        const reportTableBody = document.getElementById('report-table-body');
        const exportMonthlyBtn = document.getElementById('export-monthly-btn');

        // AI DOM å…ƒç´ 
        const generateAiBtn = document.getElementById('generate-ai-btn');
        const aiLoading = document.getElementById('ai-loading');
        const aiResultDiv = document.getElementById('ai-result');
        const aiSourcesDiv = document.getElementById('ai-sources');
        const showdownConverter = new showdown.Converter(); // ç”¨æ–¼ Markdown è½‰æ›

        // åˆ†é æŒ‰éˆ•
        const tabs = {
            report: { btn: document.getElementById('tab-report'), content: document.getElementById('content-report') },
            sales: { btn: document.getElementById('tab-chart-sales'), content: document.getElementById('content-chart-sales') },
            inv: { btn: document.getElementById('tab-chart-inv'), content: document.getElementById('content-chart-inv') },
            net: { btn: document.getElementById('tab-chart-net'), content: document.getElementById('content-chart-net') },
            total: { btn: document.getElementById('tab-chart-total'), content: document.getElementById('content-chart-total') },
            ai: { btn: document.getElementById('tab-ai'), content: document.getElementById('content-ai') },
            stocktake: { btn: document.getElementById('tab-stocktake'), content: document.getElementById('content-stocktake') }
        };

        // å…¨åŸŸè³‡æ–™ç‹€æ…‹
        let salesData = new Map(); // éŠ·å”®ç”¢å“è³‡æ–™
        let salesCategoryData = new Map(); // éŠ·å”®åˆ†é¡è³‡æ–™
        let salesMonthlyTotals = new Map(); // éŠ·å”®æ¯æœˆç¸½é¡
        let allSalesPeriods = new Set(); // æ‰€æœ‰éŠ·å”®æ™‚é–“é»
        
        let inventoryFilesCache = []; // é€²è²¨æª”æ¡ˆå¿«å–
        let inventoryData = new Map(); // é€²è²¨ç”¢å“è³‡æ–™
        let inventoryCategoryData = new Map(); // é€²è²¨åˆ†é¡è³‡æ–™
        let inventoryMonthlyTotals = new Map(); // é€²è²¨æ¯æœˆç¸½é¡
        let allInventoryPeriods = new Set(); // æ‰€æœ‰é€²è²¨æ™‚é–“é»
        
        let combinedData = new Map(); // åˆä½µç”¢å“è³‡æ–™ (for Tab 4)
        let combinedCategoryData = new Map(); // åˆä½µåˆ†é¡è³‡æ–™ (for Tab 4)
        let combinedMonthlyTotals = new Map(); // åˆä½µæ¯æœˆç¸½é¡ (for Export & Tab 5)
        let allCombinedPeriods = []; // æ‰€æœ‰æ™‚é–“é»

        // **ä¿®æ­£**: æ¬„ä½åç¨±
        let stocktakeData = new Map(); // ç›¤é»è³‡æ–™ (å³æ™‚åº«å­˜)

        // åœ–è¡¨å¯¦ä¾‹
        let chartInstances = {
            sales: null,
            inv: null,
            net: null,
            total: null
        };
        
        const CHART_COLORS = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899', '#14B8A6', '#D946EF', '#0EA5E9'];
        const TOTAL_AMOUNT_COLOR = '#6D28D9'; // ç´«è‰² (ç”¨æ–¼æ·¨åˆ©)
        
        // --- é€šç”¨åŠŸèƒ½ ---
        function showLoading(text) {
            loadingText.textContent = text || 'æ­£åœ¨è™•ç†è³‡æ–™...';
            loadingDiv.classList.remove('hidden');
        }
        function hideLoading() { loadingDiv.classList.add('hidden'); }
        
        function getCategoryFromName(name) {
            if (typeof name !== 'string') return 'å…¶ä»–';
            
            // **ä¿®æ­£**: æ›´æ–°åˆ†é¡é‚è¼¯
            if (name.includes('æœå‹™è²»')) return 'æœå‹™è²»';
            if (name.includes('å¯„è³£')) return 'å¯„è³£';
            if (name.includes('å–®å¡') || name.includes('æ”¶è—å¡')) return 'å–®å¡'; // æ”¶è—å¡ æ­¸å…¥ å–®å¡

            const parts = name.split('_');
            if (parts.length > 1 && parts[0].match(/^[a-zA-Z0-9]+$/)) { return parts[0]; }
            return 'å…¶ä»–'; 
        }

        // **ä¿®æ­£**: æ›´æ–°å‚™è¨»é‚è¼¯
        function getRemarks(name) {
            if (typeof name !== 'string') return 'å…¶ä»–';
            if (name.includes('æœå‹™è²»') || name.includes('æ¯”è³½')) return 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)';
            if (name.includes('å–®å¡') || name.includes('å¯„è³£')) return 'å–®å¡/å¯„è³£ (ç„¡é€²é …)';
            
            const TCG_KEYWORDS = ['ç¦®ç›’', 'é çµ„', 'è£œå……åŒ…', 'æ”¶è—ç›’', 'è£œå……', 'æ”¶è—å¡'];
            if (TCG_KEYWORDS.some(k => name.includes(k))) return 'ç”¢å“ç·š/å¡ç‰Œ';
            
            // **ä¿®æ­£**: æ–°å¢ "å¥—çµ„" é—œéµå­—
            const PERIPHERAL_KEYWORDS = ['å¡å¥—', 'æ¡Œå¢Š', 'å¡ç›’', 'å‘¨é‚Š', 'å¡å¤¾', 'å¡æœ¬', 'éŠæˆ²å¥—ä»¶', 'å¥—çµ„'];
            if (PERIPHERAL_KEYWORDS.some(k => name.includes(k))) return 'ç”¢å“ç·š/å‘¨é‚Š';
            
            return 'å…¶ä»–';
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        resolve(json);
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // --- æª”æ¡ˆä¸Šå‚³è¨­å®š (éŠ·å”®) ---
        dropZoneSales.addEventListener('click', () => fileInputSales.click());
        dropZoneSales.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneSales.classList.add('dragover'); });
        dropZoneSales.addEventListener('dragleave', (e) => { e.preventDefault(); dropZoneSales.classList.remove('dragover'); });
        dropZoneSales.addEventListener('drop', (e) => {
            e.preventDefault(); dropZoneSales.classList.remove('dragover');
            fileInputSales.files = e.dataTransfer.files;
            handleSalesFiles(fileInputSales.files);
        });
        fileInputSales.addEventListener('change', (e) => handleSalesFiles(e.target.files));

        // --- æª”æ¡ˆä¸Šå‚³è¨­å®š (é€²è²¨) ---
        dropZoneInv.addEventListener('click', () => fileInputInv.click());
        dropZoneInv.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneInv.classList.add('dragover'); });
        dropZoneInv.addEventListener('dragleave', (e) => { e.preventDefault(); dropZoneInv.classList.remove('dragover'); });
        dropZoneInv.addEventListener('drop', (e) => {
            e.preventDefault(); dropZoneInv.classList.remove('dragover');
            fileInputInv.files = e.dataTransfer.files;
            handleInventoryFiles(fileInputInv.files);
        });
        fileInputInv.addEventListener('change', (e) => handleInventoryFiles(e.target.files));
        
        // æª”æ¡ˆä¸Šå‚³è¨­å®š (ç›¤é»)
        dropZoneStocktake.addEventListener('click', () => fileInputStocktake.click());
        dropZoneStocktake.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneStocktake.classList.add('dragover'); });
        dropZoneStocktake.addEventListener('dragleave', (e) => { e.preventDefault(); dropZoneStocktake.classList.remove('dragover'); });
        dropZoneStocktake.addEventListener('drop', (e) => {
            e.preventDefault(); dropZoneStocktake.classList.remove('dragover');
            fileInputStocktake.files = e.dataTransfer.files;
            handleStocktakeFile(fileInputStocktake.files);
        });
        fileInputStocktake.addEventListener('change', (e) => handleStocktakeFile(e.target.files));
        
        
        // å€‰åº«é¸æ“‡ç›£è½
        warehouseSelect.addEventListener('change', processSelectedWarehouse);

        // --- æ ¸å¿ƒè³‡æ–™è™•ç† 1: è™•ç†éŠ·å”®æª”æ¡ˆ ---
        async function handleSalesFiles(files) {
            if (files.length === 0) return;
            showLoading('æ­£åœ¨è™•ç†éŠ·å”®è³‡æ–™...');
            fileListSales.innerHTML = `<p class="font-semibold mb-1">å·²é¸æ“‡éŠ·å”®æª”æ¡ˆ (${files.length}):</p><ul>` +
                [...files].map(f => `<li class="ml-4 list-disc">${f.name}</li>`).join('') + '</ul>';

            // é‡ç½®éŠ·å”®è³‡æ–™
            salesData = new Map();
            salesCategoryData = new Map();
            salesMonthlyTotals = new Map();
            allSalesPeriods = new Set();
            
            function parseSalesPeriod(filename) {
                const match = filename.match(/(\d{4})(Q\d|\d{2})/);
                if (!match) return null;
                const year = match[1]; let period = match[2];
                if (period.startsWith('Q')) {
                    const quarterMonth = { 'Q1': '03', 'Q2': '06', 'Q3': '09', 'Q4': '12' };
                    return `${year}-${quarterMonth[period]}`;
                }
                return `${year}-${period}`;
            }

            for (const file of files) {
                const period = parseSalesPeriod(file.name);
                if (!period) { console.warn(`ç„¡æ³•å¾æª”å ${file.name} è§£ææ™‚é–“ï¼Œå·²è·³éã€‚`); continue; }
                allSalesPeriods.add(period);
                
                try {
                    const data = await readFile(file);
                    data.forEach(row => {
                        const productId = row['å“è™Ÿ'] || 'æœªçŸ¥å“è™Ÿ';
                        const productName = row['å“å'] || 'æœªçŸ¥å“å';
                        // æ ¹æ“šä½¿ç”¨è€…èªªæ˜ï¼Œ"éŠ·è²¨æ·¨é‡" å·²æ˜¯æœ€çµ‚éŠ·å”®é‡
                        const salesQuantity = Number(row['éŠ·è²¨æ·¨é‡']) || 0;
                        const salesAmount = Number(row['éŠ·è²¨æ·¨é¡']) || 0; 
                        const category = getCategoryFromName(productName); 

                        // 1. æ¯æœˆç¸½é¡
                        if (!salesMonthlyTotals.has(period)) salesMonthlyTotals.set(period, { amount: 0, quantity: 0 });
                        const totals = salesMonthlyTotals.get(period);
                        totals.amount += salesAmount;
                        totals.quantity += salesQuantity;

                        // 2. ç”¢å“è³‡æ–™
                        if (!salesData.has(productId)) salesData.set(productId, { name: productName, category: category, totalSales: 0, totalAmount: 0, salesByPeriod: {}, amountByPeriod: {} });
                        const p = salesData.get(productId);
                        p.totalSales += salesQuantity;
                        p.totalAmount += salesAmount;
                        p.salesByPeriod[period] = (p.salesByPeriod[period] || 0) + salesQuantity;
                        p.amountByPeriod[period] = (p.amountByPeriod[period] || 0) + salesAmount;

                        // 3. åˆ†é¡è³‡æ–™
                        if (!salesCategoryData.has(category)) salesCategoryData.set(category, { totalAmount: 0, amountByPeriod: {}, totalSales: 0, salesByPeriod: {} });
                        const c = salesCategoryData.get(category);
                        c.totalAmount += salesAmount;
                        c.amountByPeriod[period] = (c.amountByPeriod[period] || 0) + salesAmount;
                        c.totalSales += salesQuantity;
                        c.salesByPeriod[period] = (c.salesByPeriod[period] || 0) + salesQuantity;
                    });
                } catch (error) { console.error(`è™•ç†éŠ·å”®æª”æ¡ˆ ${file.name} å¤±æ•—:`, error); }
            }
            
            await updateCombinedData(); // æ›´æ–°åˆä½µè³‡æ–™
            
            // å»¶é²åŸ·è¡Œ DOM æ›´æ–° (æ•ˆèƒ½å„ªåŒ–)
            setTimeout(() => {
                if (salesData.size > 0) {
                    resultSection.classList.remove('hidden');
                    populateReportTable(); 
                    setupChartFramework('sales', salesData, salesCategoryData, allSalesPeriods, 'salesByPeriod', 'amountByPeriod');
                    
                    tabs.total.btn.disabled = false;
                    tabs.total.btn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    drawTotalChart(); 
                    
                    // å•Ÿç”¨ç›¤é» Tab
                    tabs.stocktake.btn.disabled = false;
                    tabs.stocktake.btn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    compareStocktake(); // æ¯”è¼ƒ (å¦‚æœç›¤é»è³‡æ–™å·²å­˜åœ¨)
                    
                } else {
                    fileListSales.innerHTML += '<p class="text-red-500 mt-4">æœªè®€å–åˆ°æœ‰æ•ˆéŠ·å”®è³‡æ–™ã€‚</p>';
                }
                hideLoading();
            }, 100); 
        }

        // --- æ ¸å¿ƒè³‡æ–™è™•ç† 2: æƒæé€²è²¨æª”æ¡ˆ (å–å¾—å€‰åº«) ---
        async function handleInventoryFiles(files) {
            if (files.length === 0) return;
            inventoryFilesCache = [...files]; // å„²å­˜æª”æ¡ˆå¿«å–
            showLoading('æ­£åœ¨æƒæé€²è²¨æª”æ¡ˆï¼Œè«‹ç¨å€™...');
            fileListInv.innerHTML = `<p class="font-semibold mb-1">å·²é¸æ“‡é€²è²¨æª”æ¡ˆ (${files.length}):</p><ul>` +
                [...files].map(f => `<li class="ml-4 list-disc">${f.name}</li>`).join('') + '</ul>';

            const warehouseSet = new Set();
            for (const file of inventoryFilesCache) {
                try {
                    const data = await readFile(file);
                    data.forEach(row => {
                        if (row['å€‰åº«']) warehouseSet.add(row['å€‰åº«']);
                    });
                } catch (error) { console.error(`æƒæé€²è²¨æª”æ¡ˆ ${file.name} å¤±æ•—:`, error); }
            }
            
            warehouseSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸€å€‹å€‰åº« --</option>';
            [...warehouseSet].sort().forEach(w => {
                warehouseSelect.innerHTML += `<option value="${w}">${w}</option>`;
            });
            
            warehouseSelectionDiv.classList.remove('hidden');
            hideLoading();
        }
        
        // --- æ ¸å¿ƒè³‡æ–™è™•ç† 3: è™•ç†é¸å®šå€‰åº«çš„é€²è²¨è³‡æ–™ ---
        async function processSelectedWarehouse() {
            const selectedWarehouse = warehouseSelect.value;
            
            // é‡ç½®é€²è²¨ç›¸é—œè³‡æ–™
            inventoryData = new Map();
            inventoryCategoryData = new Map();
            inventoryMonthlyTotals = new Map();
            allInventoryPeriods = new Set();
            
            // ç¦ç”¨åœ–è¡¨åˆ†é 
            tabs.inv.btn.disabled = true;
            tabs.inv.btn.classList.add('text-gray-400', 'cursor-not-allowed');
            tabs.net.btn.disabled = true;
            tabs.net.btn.classList.add('text-gray-400', 'cursor-not-allowed');

            if (!selectedWarehouse) {
                await updateCombinedData();
                populateReportTable(); 
                drawTotalChart(); 
                compareStocktake(); // é‡ç®—æ¯”è¼ƒ
                return;
            }
            
            showLoading(`æ­£åœ¨è™•ç† ${selectedWarehouse} çš„é€²è²¨è³‡æ–™...`);
            
            function parseInvPeriod(orderId) {
                if (typeof orderId !== 'string') return null;
                const match = orderId.match(/(\d{4})(\d{2})/); // "é€² 20250101002" -> "2025", "01"
                if (match && match[1] && match[2]) {
                    return `${match[1]}-${match[2]}`;
                }
                return null;
            }

            for (const file of inventoryFilesCache) {
                try {
                    const data = await readFile(file);
                    data.forEach(row => {
                        if (row['å€‰åº«'] !== selectedWarehouse) return; 
                        
                        const period = parseInvPeriod(row['å–®è™Ÿ']);
                        if (!period) return;
                        allInventoryPeriods.add(period);

                        const productId = row['å“è™Ÿ'] || 'æœªçŸ¥å“è™Ÿ';
                        const productName = row['å“å'] || 'æœªçŸ¥å“å';
                        const invQuantity = Number(row['æ•¸é‡']) || 0;
                        const invAmount = Number(row['é‡‘é¡']) || 0; 
                        const category = getCategoryFromName(productName); 

                        // 1. æ¯æœˆç¸½é¡
                        if (!inventoryMonthlyTotals.has(period)) inventoryMonthlyTotals.set(period, { amount: 0, quantity: 0 });
                        const totals = inventoryMonthlyTotals.get(period);
                        totals.amount += invAmount;
                        totals.quantity += invQuantity;

                        // 2. ç”¢å“è³‡æ–™
                        // (ä½¿ç”¨ totalSales, totalAmount ä½œç‚º "quantity" å’Œ "amount" çš„éµ)
                        if (!inventoryData.has(productId)) inventoryData.set(productId, { name: productName, category: category, totalSales: 0, totalAmount: 0, salesByPeriod: {}, amountByPeriod: {} });
                        const p = inventoryData.get(productId);
                        p.totalSales += invQuantity;
                        p.totalAmount += invAmount;
                        p.salesByPeriod[period] = (p.salesByPeriod[period] || 0) + invQuantity;
                        p.amountByPeriod[period] = (p.amountByPeriod[period] || 0) + invAmount;

                        // 3. åˆ†é¡è³‡æ–™
                        if (!inventoryCategoryData.has(category)) inventoryCategoryData.set(category, { totalAmount: 0, amountByPeriod: {}, totalSales: 0, salesByPeriod: {} });
                        const c = inventoryCategoryData.get(category);
                        c.totalAmount += invAmount;
                        c.amountByPeriod[period] = (c.amountByPeriod[period] || 0) + invAmount;
                        c.totalSales += invQuantity;
                        c.salesByPeriod[period] = (c.salesByPeriod[period] || 0) + invQuantity;
                    });
                } catch (error) { console.error(`è™•ç†é€²è²¨æª”æ¡ˆ ${file.name} å¤±æ•—:`, error); }
            }

            await updateCombinedData(); // æ›´æ–°åˆä½µè³‡æ–™

            // å»¶é²åŸ·è¡Œ DOM æ›´æ–°
            setTimeout(() => {
                populateReportTable(); 
                if (inventoryData.size > 0) {
                    // å•Ÿç”¨ä¸¦åˆ·æ–°é€²è²¨åˆ†é  (Tab 3)
                    tabs.inv.btn.disabled = false;
                    tabs.inv.btn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    setupChartFramework('inv', inventoryData, inventoryCategoryData, allInventoryPeriods, 'salesByPeriod', 'amountByPeriod');
                    
                    // å•Ÿç”¨ä¸¦åˆ·æ–°é€²éŠ·å­˜åˆ†é  (Tab 4)
                    tabs.net.btn.disabled = false;
                    tabs.net.btn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    setupChartFramework('net', combinedData, combinedCategoryData, new Set(allCombinedPeriods), 'netSalesByPeriod', 'netAmountByPeriod');
                    
                    drawTotalChart();
                } else {
                     fileListInv.innerHTML += `<p class="text-red-500 mt-4">åœ¨ ${selectedWarehouse} æœªè®€å–åˆ°æœ‰æ•ˆé€²è²¨è³‡æ–™ã€‚</p>`;
                }
                
                // é‡ç®—æ¯”è¼ƒ
                compareStocktake();
                
                hideLoading();
            }, 100);
        }
        
        // --- æ ¸å¿ƒè³‡æ–™è™•ç† 5: è™•ç†ç›¤é»æª”æ¡ˆ ---
        async function handleStocktakeFile(files) {
            if (files.length === 0) return;
            if (files.length > 1) {
                fileListStocktake.innerHTML = '<p class="text-red-500">ä¸€æ¬¡åªèƒ½ä¸Šå‚³ä¸€å€‹ç›¤é»æª”æ¡ˆã€‚</p>';
                return;
            }
            const file = files[0];
            showLoading('æ­£åœ¨è™•ç†ç›¤é»è³‡æ–™...');
            fileListStocktake.innerHTML = `<p class="font-semibold mb-1">å·²é¸æ“‡ç›¤é»æª”æ¡ˆ:</p><li class="ml-4 list-disc">${file.name}</li>`;

            stocktakeData = new Map(); // é‡ç½®
            
            try {
                const data = await readFile(file);
                let count = 0;
                data.forEach(row => {
                    const productName = row['å“å'];
                    // **ä¿®æ­£**: æ¬„ä½åç¨±
                    const quantity = Number(row['åº«å­˜æ•¸é‡']);
                    if (productName && !isNaN(quantity)) {
                        stocktakeData.set(productName, quantity);
                        count++;
                    }
                });
                
                if (count > 0) {
                    compareStocktake(); // è®€å–å®Œç•¢ï¼Œç«‹å³æ¯”è¼ƒ
                } else {
                    // **ä¿®æ­£**: æ›´æ–°éŒ¯èª¤è¨Šæ¯ï¼Œè®“å®ƒæ›´æº–ç¢º
                    fileListStocktake.innerHTML += '<p class="text-red-500 mt-4">æœªè®€å–åˆ°æœ‰æ•ˆçš„ç›¤é»è³‡æ–™ (è«‹ç¢ºèªæ¬„ä½ç‚º "å“å" å’Œ "åº«å­˜æ•¸é‡")ã€‚</p>';
                }
            } catch (error) {
                console.error(`è™•ç†ç›¤é»æª”æ¡ˆ ${file.name} å¤±æ•—:`, error);
                fileListStocktake.innerHTML += `<p class="text-red-500 mt-4">æª”æ¡ˆè®€å–å¤±æ•—: ${error.message}</p>`;
            }
            hideLoading();
        }


        // --- æ ¸å¿ƒè³‡æ–™è™•ç† 6: æ›´æ–°åˆä½µè³‡æ–™ (é€²éŠ·å­˜) ---
        async function updateCombinedData() {
            combinedData = new Map();
            combinedCategoryData = new Map();
            combinedMonthlyTotals = new Map();
            const allProductIds = new Set([...salesData.keys(), ...inventoryData.keys()]);
            const allPeriodsSet = new Set([...allSalesPeriods, ...allInventoryPeriods]);
            allCombinedPeriods = [...allPeriodsSet].sort();

            let commissionSalesByPeriod = {};
            // æœå‹™è²»éŠ·å”®é¡ (ç”¨æ–¼ 20% åˆ©æ½¤è¨ˆç®—)
            let serviceSalesByPeriod = {};

            allProductIds.forEach(id => {
                const s = salesData.get(id);
                const i = inventoryData.get(id);
                
                const name = s?.name || i?.name || 'æœªçŸ¥ç”¢å“';
                const category = s?.category || i?.category || getCategoryFromName(name); // ç¢ºä¿åˆ†é¡ä¸€è‡´
                
                let totalNetSales = 0;
                let totalNetAmount = 0;
                let netSalesByPeriod = {};
                let netAmountByPeriod = {};

                // **ä¿®æ­£**: å€åˆ†å¯„è³£/å–®å¡ (10%) å’Œ æœå‹™è²» (20%)
                if (category === 'å¯„è³£' || category === 'å–®å¡') {
                    allCombinedPeriods.forEach(p => {
                        const salesAmt = s?.amountByPeriod[p] || 0;
                        commissionSalesByPeriod[p] = (commissionSalesByPeriod[p] || 0) + salesAmt;
                    });
                } else if (category === 'æœå‹™è²»') {
                    allCombinedPeriods.forEach(p => {
                        const salesAmt = s?.amountByPeriod[p] || 0;
                        serviceSalesByPeriod[p] = (serviceSalesByPeriod[p] || 0) + salesAmt;
                    });
                }

                allCombinedPeriods.forEach(p => {
                    const salesQty = s?.salesByPeriod[p] || 0;
                    const salesAmt = s?.amountByPeriod[p] || 0;
                    const invQty = i?.salesByPeriod[p] || 0; // é€²è²¨é‡
                    const invAmt = i?.amountByPeriod[p] || 0; // é€²è²¨é¡

                    // **ä¿®æ­£**: æ¬„ä½åç¨± (é€²éŠ·åº«å­˜)
                    const netQty = invQty - salesQty; // é€²éŠ·åº«å­˜ = ç¸½é€² - ç¸½éŠ·
                    let netAmt = salesAmt - invAmt; // é è¨­æ·¨åˆ© (Tab 4 ä½¿ç”¨)
                                            
                    netSalesByPeriod[p] = netQty;
                    netAmountByPeriod[p] = netAmt; // (Tab 4 ç”¨çš„ "æ·¨åˆ©")
                    totalNetSales += netQty;
                    totalNetAmount += netAmt;
                });

                combinedData.set(id, {
                    name: name,
                    category: category,
                    totalSales: totalNetSales, // ç¸½é€²éŠ·åº«å­˜
                    totalAmount: totalNetAmount, // ç¸½ (éŠ·å”®é¡ - é€²è²¨é¡)
                    netSalesByPeriod: netSalesByPeriod,
                    netAmountByPeriod: netAmountByPeriod
                });

                // æ›´æ–°åˆä½µå¾Œçš„åˆ†é¡è³‡æ–™ (for Tab 4)
                if (!combinedCategoryData.has(category)) combinedCategoryData.set(category, { totalAmount: 0, amountByPeriod: {}, totalSales: 0, salesByPeriod: {} });
                const c = combinedCategoryData.get(category);
                c.totalAmount += totalNetAmount;
                c.totalSales += totalNetSales;
                allCombinedPeriods.forEach(p => {
                    c.amountByPeriod[p] = (c.amountByPeriod[p] || 0) + netAmountByPeriod[p];
                    c.salesByPeriod[p] = (c.salesByPeriod[p] || 0) + netSalesByPeriod[p];
                });
            });

            // æ›´æ–°åˆä½µå¾Œçš„æ¯æœˆç¸½é¡ (for Tab 5 & Export)
            allCombinedPeriods.forEach(p => {
                const s = salesMonthlyTotals.get(p) || { amount: 0, quantity: 0 };
                const i = inventoryMonthlyTotals.get(p) || { amount: 0, quantity: 0 };
                const commissionSales = commissionSalesByPeriod[p] || 0; 
                // å–å¾—ç•¶æœŸæœå‹™è²»
                const serviceSales = serviceSalesByPeriod[p] || 0; 

                // **ä¿®æ­£**: æ·¨åˆ© = (ç¸½éŠ·å”® - å¯„è³£/å–®å¡ - æœå‹™è²») - ç¸½é€²è²¨ + (å¯„è³£/å–®å¡ * 0.1) + (æœå‹™è²» * 0.2)
                const netAmount = (s.amount - commissionSales - serviceSales) - i.amount + (commissionSales * 0.10) + (serviceSales * 0.20);
                const netQuantity = s.quantity - i.quantity; // é€™æ˜¯æ¯æœˆæ·¨éŠ·å”® (éåº«å­˜)

                combinedMonthlyTotals.set(p, {
                    salesAmount: s.amount,
                    salesQuantity: s.quantity,
                    invAmount: i.amount,
                    invQuantity: i.quantity,
                    netAmount: netAmount, // é€™æ˜¯ **å¯¦éš›æ·¨åˆ©**
                    netQuantity: netQuantity
                });
            });
        }

        // --- Tab 1: å½™ç¸½å ±è¡¨ ---
        function populateReportTable() {
            reportTableBody.innerHTML = '';
            
            const sortedData = [...combinedData.entries()].map(([id, netInfo]) => {
                const s = salesData.get(id) || { totalSales: 0, totalAmount: 0 };
                const category = netInfo.category;
                // **ä¿®æ­£**: åˆ©æ½¤è¨ˆç®—æ”¹ç”¨ remarks
                const remarks = getRemarks(netInfo.name);
                
                // **ä¿®æ­£**: æ·¨åˆ© = ä¾ remarks å€åˆ†
                let totalProfit;
                if (remarks === 'å–®å¡/å¯„è³£ (ç„¡é€²é …)') {
                    totalProfit = s.totalAmount * 0.10;
                } else if (remarks === 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)') {
                    totalProfit = s.totalAmount * 0.20;
                } else {
                    totalProfit = netInfo.totalAmount; // (ç¸½éŠ·è²¨é¡ - ç¸½é€²è²¨é¡)
                }
                
                return [id, netInfo, totalProfit];
            }).sort((a, b) => b[2] - a[2]); // ä¾ç…§ [2] (totalProfit) æ’åº
            
            for (const [id, netInfo, totalProfit] of sortedData) {
                const s = salesData.get(id) || { totalSales: 0, totalAmount: 0 };
                const i = inventoryData.get(id) || { totalSales: 0, totalAmount: 0 }; 

                const row = document.createElement('tr');
                // **ä¿®æ­£**: æ¬„ä½åç¨± (é€²éŠ·åº«å­˜)
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${netInfo.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${netInfo.category || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${s.totalSales.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${s.totalAmount.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${i.totalSales.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${i.totalAmount.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${netInfo.totalSales.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-bold">${Math.round(totalProfit).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getRemarks(netInfo.name)}</td>
                `;
                reportTableBody.appendChild(row);
            }
        }
        
        exportMonthlyBtn.addEventListener('click', () => {
            if (!combinedMonthlyTotals || combinedMonthlyTotals.size === 0) { alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚"); return; }
            
            const wb = XLSX.utils.book_new();
            
            // å·¥ä½œè¡¨ 1ï¼šæ¯æœˆé€²éŠ·å­˜ (å·²åŒ…å«å¯„è³£/å–®å¡åˆ©æ½¤ä¿®æ­£)
            const dataMonthly = [
                ['æ™‚é–“', 'éŠ·å”®æ•¸é‡', 'éŠ·å”®ç¸½é¡', 'é€²è²¨æ•¸é‡', 'é€²è²¨ç¸½é¡', 'æ·¨éŠ·å”®', 'æ·¨åˆ©'],
                ...[...combinedMonthlyTotals.entries()]
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([period, data]) => [
                        period, data.salesQuantity, data.salesAmount,
                        data.invQuantity, data.invAmount,
                        data.netQuantity, Math.round(data.netAmount)
                    ])
            ];
            const ws_monthly = XLSX.utils.aoa_to_sheet(dataMonthly);
            XLSX.utils.book_append_sheet(wb, ws_monthly, "æ¯æœˆé€²éŠ·å­˜");

            // **ä¿®æ­£**: å·¥ä½œè¡¨ 2ï¼šç”¢å“æ·¨åˆ©å½™ç¸½ (éœ€åŒ…å«å¯„è³£/å–®å¡åˆ©æ½¤ä¿®æ­£)
            const productProfitHeaders = [
                'å“è™Ÿ', 'å“å', 'åˆ†é¡', 
                'ç¸½éŠ·è²¨é‡', 'ç¸½éŠ·è²¨é¡', 
                'ç¸½é€²è²¨é‡', 'ç¸½é€²è²¨é¡', 
                'é€²éŠ·åº«å­˜', 'å³æ™‚åº«å­˜', 'æ·¨åˆ©', 'å‚™è¨»' // **æ–°å¢**: å³æ™‚åº«å­˜
            ];
            
            const productProfitData = [...combinedData.entries()].map(([id, netData]) => {
                const s = salesData.get(id) || { totalSales: 0, totalAmount: 0 };
                const i = inventoryData.get(id) || { totalSales: 0, totalAmount: 0 }; 
                const category = netData.category;
                const remarks = getRemarks(netData.name);
                
                let totalProfit;
                if (remarks === 'å–®å¡/å¯„è³£ (ç„¡é€²é …)') {
                    totalProfit = s.totalAmount * 0.10;
                } else if (remarks === 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)') {
                    totalProfit = s.totalAmount * 0.20;
                } else {
                    totalProfit = netData.totalAmount; // (ç¸½éŠ·è²¨é¡ - ç¸½é€²è²¨é¡)
                }
                
                // **æ–°å¢**: ç²å–å³æ™‚åº«å­˜
                const realTimeStock = stocktakeData.get(netData.name) || 0;
                
                return [
                    id,
                    netData.name,
                    category,
                    s.totalSales, s.totalAmount,
                    i.totalSales, i.totalAmount,
                    netData.totalSales, // é€²éŠ·åº«å­˜
                    realTimeStock, // **æ–°å¢**: å³æ™‚åº«å­˜
                    Math.round(totalProfit),
                    getRemarks(netData.name) 
                ];
            });
            // **ä¿®æ­£**: ä¾æ·¨åˆ© (index 9) æ’åº
            productProfitData.sort((a, b) => b[9] - a[9]); 
            
            const ws_product_pnl = XLSX.utils.aoa_to_sheet([productProfitHeaders, ...productProfitData]);
            XLSX.utils.book_append_sheet(wb, ws_product_pnl, "ç”¢å“æ·¨åˆ©å½™ç¸½");
            
            // **æ–°å¢**: å·¥ä½œè¡¨ 3ï¼šå–®å“é€æœˆè³‡æ–™
            const productPeriodHeaders = [
                'å“è™Ÿ', 'å“å', 'åˆ†é¡', 'æ™‚é–“',
                'æœŸé–“éŠ·è²¨é‡', 'æœŸé–“éŠ·è²¨é¡',
                'æœŸé–“é€²è²¨é‡', 'æœŸé–“é€²è²¨é¡',
                'æœŸé–“æ·¨åˆ©', 'æœŸé–“åº«å­˜è®Šå‹•'
            ];
            const productPeriodData = [];
            
            [...combinedData.entries()].forEach(([id, netData]) => {
                const s = salesData.get(id);
                const i = inventoryData.get(id);
                const category = netData.category;
                const remarks = getRemarks(netData.name);

                allCombinedPeriods.forEach(period => {
                    const salesQty = s?.salesByPeriod[period] || 0;
                    const salesAmt = s?.amountByPeriod[period] || 0;
                    const invQty = i?.salesByPeriod[period] || 0;
                    const invAmt = i?.amountByPeriod[period] || 0;

                    if (salesQty !== 0 || salesAmt !== 0 || invQty !== 0 || invAmt !== 0) {
                        let periodProfit;
                        if (remarks === 'å–®å¡/å¯„è³£ (ç„¡é€²é …)') {
                            periodProfit = salesAmt * 0.10;
                        } else if (remarks === 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)') {
                            periodProfit = salesAmt * 0.20;
                        } else {
                            periodProfit = salesAmt - invAmt; // æœŸé–“ (éŠ·å”®é¡ - é€²è²¨é¡)
                        }
                        
                        const stockChange = invQty - salesQty; // æœŸé–“åº«å­˜è®Šå‹•

                        productPeriodData.push([
                            id, netData.name, category, period,
                            salesQty, salesAmt,
                            invQty, invAmt,
                            Math.round(periodProfit),
                            stockChange
                        ]);
                    }
                });
            });
            // ä¾ å“å -> æ™‚é–“ æ’åº
            productPeriodData.sort((a, b) => {
                if (a[1] !== b[1]) return a[1].localeCompare(b[1]);
                return a[3].localeCompare(b[3]);
            });
            const ws_product_period = XLSX.utils.aoa_to_sheet([productPeriodHeaders, ...productPeriodData]);
            XLSX.utils.book_append_sheet(wb, ws_product_period, "å–®å“é€æœˆè³‡æ–™");
            
            
            // å·¥ä½œè¡¨ 4ï¼šAI åˆ†æå ±å‘Š
            const aiText = aiResultDiv.innerText;
            if (aiText && !aiText.includes('é»æ“ŠæŒ‰éˆ•ä»¥ç”¢ç”Ÿ')) {
                // å°‡ç´”æ–‡å­—æŒ‰è¡Œåˆ†å‰²ï¼Œæ”¾å…¥ Excel
                const aiData = aiText.split('\n').map(line => [line]);
                const ws_ai = XLSX.utils.aoa_to_sheet(aiData);
                // å˜—è©¦è¨­ç½®ç¬¬ä¸€æ¬„çš„å¯¬åº¦
                ws_ai['!cols'] = [{ wch: 100 }]; // è¨­ç½® A æ¬„å¯¬åº¦ç‚º 100
                XLSX.utils.book_append_sheet(wb, ws_ai, "AIåˆ†æå ±å‘Š");
            }

            XLSX.writeFile(wb, "é€²éŠ·å­˜å½™ç¸½å ±è¡¨.xlsx");
        });

        // --- Tab 2, 3, 4: åœ–è¡¨é€šç”¨æ¡†æ¶ ---
        
        /**
         * è¨­å®šåœ–è¡¨æ¡†æ¶ (è¨»å†Šæ‰€æœ‰ç›£è½å™¨)
         * @param {string} type - 'sales', 'inv', 'net'
         * @param {Map} pData - productData (salesData, inventoryData, or combinedData)
         * @param {Map} cData - categoryData (salesCategoryData, etc.)
         * @param {Set} periodsSet - allSalesPeriods, allInventoryPeriods, etc.
         * @param {string} qtyKey - 'salesByPeriod' or 'netSalesByPeriod'
         * @param {string} amtKey - 'amountByPeriod' or 'netAmountByPeriod'
         */
        function setupChartFramework(type, pData, cData, periodsSet, qtyKey, amtKey) {
            let isSelectAllBusy = false;

            const modeAmount = document.getElementById(`mode-amount-${type}`);
            const modeQuantity = document.getElementById(`mode-quantity-${type}`);
            const selectAllCat = document.getElementById(`select-all-categories-${type}`);
            const selectAllProd = document.getElementById(`select-all-products-${type}`);
            const itemSelectionDiv = document.getElementById(`chart-item-selection-${type}`);
            const chartCanvas = document.getElementById(`sales-chart-${type}`);

            // ç²å–ç•¶å‰è¨­å®š
            const getCurrentSettings = () => {
                const mode = document.querySelector(`input[name="chart-mode-${type}"]:checked`).value;
                const periods = [...periodsSet].sort();
                const dataKey = (mode === 'amount') ? amtKey : qtyKey;
                
                let yLabel = '';
                if (type === 'sales') {
                    yLabel = (mode === 'amount') ? 'éŠ·å”®ç¸½é¡' : 'éŠ·å”®æ•¸é‡';
                } else if (type === 'inv') {
                    yLabel = (mode === 'amount') ? 'é€²è²¨ç¸½é¡' : 'é€²è²¨æ•¸é‡';
                } else { // net
                    // **ä¿®æ­£**: æ¬„ä½åç¨±
                    yLabel = (mode === 'amount') ? 'æ·¨åˆ© (éŠ·å”®é¡ - é€²è²¨é¡)' : 'é€²éŠ·åº«å­˜ (ç¸½é€² - ç¸½éŠ·)';
                }

                return { mode, periods, dataKey, yLabel };
            };

            // 1. ç¹ªè£½åœ–è¡¨
            const drawChart = () => {
                if (chartInstances[type]) chartInstances[type].destroy();
                
                const { mode, periods, dataKey, yLabel } = getCurrentSettings(); 
                const selectedInputs = Array.from(itemSelectionDiv.querySelectorAll('input:checked'));
                const datasets = [];
                
                // ç”¢å“/åˆ†é¡ç·š
                selectedInputs.forEach((input, index) => {
                    const key = input.dataset.key;
                    const dataType = input.dataset.type;
                    const color = CHART_COLORS[index % CHART_COLORS.length];
                    
                    let dataPoints = []; let label = ''; let metaData = {};
                    
                    if (dataType === 'category') {
                        const category = cData.get(key); 
                        if (category) {
                            label = `${key} (å½™ç¸½)`;
                            const sourceData = (mode === 'amount') ? category.amountByPeriod : category.salesByPeriod;
                            dataPoints = periods.map(p => (sourceData && sourceData[p]) ? sourceData[p] : 0);
                            metaData = { type: 'category', key: key };
                        }
                    } else if (dataType === 'product') {
                        const product = pData.get(key);
                        if (product) {
                            label = product.name;
                            const sourceData = (mode === 'amount') ? (product.netAmountByPeriod || product.amountByPeriod) : (product.netSalesByPeriod || product.salesByPeriod);
                            dataPoints = periods.map(p => (sourceData && sourceData[p]) ? sourceData[p] : 0);
                            metaData = { type: 'product', key: key };
                        }
                    }
                    
                    datasets.push({
                        label: label, data: dataPoints, borderColor: color, backgroundColor: `${color}33`,
                        fill: false, tension: 0.1, pointRadius: 4, pointHoverRadius: 6, meta: metaData
                    });
                }); 

                chartInstances[type] = new Chart(chartCanvas.getContext('2d'), {
                    type: 'line', data: { labels: periods, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: (type !== 'net'), title: { display: true, text: yLabel, font: { size: 14 } } },
                            x: { title: { display: true, text: 'æ™‚é–“ (å¹´-æœˆ/å­£)', font: { size: 14 } } }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index', intersect: false, itemSort: (a, b) => b.raw - a.raw,
                                callbacks: {
                                    footer: (tooltipItems) => { 
                                        if (!tooltipItems || tooltipItems.length === 0) return '';
                                        const footerLines = [];
                                        const { dataKey } = getCurrentSettings();
                                        const currentPeriod = tooltipItems[0].label;
                                        
                                        tooltipItems.forEach(item => {
                                            const chart = item.chart; 
                                            if (!chart.data || !chart.data.datasets) return;
                                            const dataset = chart.data.datasets[item.datasetIndex]; 
                                            if (!dataset || !dataset.meta) return;
                                            const meta = dataset.meta;
                                            
                                            if (meta && meta.type === 'category') {
                                                const categoryName = meta.key;
                                                const contributingProducts = [];
                                                
                                                pData.forEach((productData) => {
                                                    if (productData.category === categoryName) {
                                                        const sourceData = (dataKey === amtKey) ? (productData.netAmountByPeriod || productData.amountByPeriod) : (productData.netSalesByPeriod || productData.salesByPeriod); 
                                                        const value = (sourceData && sourceData[currentPeriod]) ? sourceData[currentPeriod] : 0;
                                                        if (value !== 0) contributingProducts.push({ name: productData.name, value: value });
                                                    }
                                                });
                                                
                                                contributingProducts.sort((a, b) => b.value - a.value);
                                                
                                                if (contributingProducts.length > 0) {
                                                    footerLines.push(''); 
                                                    footerLines.push(`--- ${categoryName} (${currentPeriod}) ---`); 
                                                    contributingProducts.slice(0, 5).forEach(prod => footerLines.push(`  ${prod.name}: ${prod.value.toLocaleString()}`));
                                                    if (contributingProducts.length > 5) footerLines.push(`  ...åŠå…¶ä»– ${contributingProducts.length - 5} å€‹ç”¢å“`);
                                                }
                                            }
                                        });
                                        return footerLines;
                                    }
                                }
                            },
                            legend: { position: 'top' },
                            // æ–°å¢ï¼šZoom Plugin è¨­å®š
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: 'xy',
                                    threshold: 5,
                                },
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    mode: 'xy',
                                    drag: {
                                        enabled: true,
                                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                        borderColor: 'rgba(59, 130, 246, 0.5)'
                                    }
                                }
                            }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false }
                    }
                });
            };

            // 2. å¡«å…¥é¸é …
            const populateChartSelection = () => {
                const { mode } = getCurrentSettings();
                itemSelectionDiv.innerHTML = '';
                const sortBy = (mode === 'amount') ? 'totalAmount' : 'totalSales';
                
                const productsByCategory = new Map();
                // **ä¿®æ­£**ï¼šç¢ºä¿ 'æœå‹™è²»', 'å¯„è³£', 'å–®å¡' åœ¨æœ€å‰é¢
                if (cData.has('æœå‹™è²»')) productsByCategory.set('æœå‹™è²»', []);
                if (cData.has('å¯„è³£')) productsByCategory.set('å¯„è³£', []);
                if (cData.has('å–®å¡')) productsByCategory.set('å–®å¡', []);
                if (cData.has('å…¶ä»–')) productsByCategory.set('å…¶ä»–', []); 

                [...pData.entries()].forEach(([id, data]) => {
                    const categoryKey = data.category || 'å…¶ä»–';
                    if (!productsByCategory.has(categoryKey)) productsByCategory.set(categoryKey, []);
                    productsByCategory.get(categoryKey).push({ id, data, sortByValue: data[sortBy] });
                });
                
                // **ä¿®æ­£**ï¼šè‡ªè¨‚æ’åº
                const sortedCategoryKeys = [...productsByCategory.keys()].sort((a, b) => {
                    const specialOrder = ['æœå‹™è²»', 'å¯„è³£', 'å–®å¡']; 
                    const aIdx = specialOrder.indexOf(a);
                    const bIdx = specialOrder.indexOf(b);
                    if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                    if (aIdx !== -1) return -1;
                    if (bIdx !== -1) return 1;
                    if (a === 'å…¶ä»–') return 1;
                    if (b === 'å…¶ä»–') return -1;
                    return a.localeCompare(b);
                });

                sortedCategoryKeys.forEach((categoryKey) => {
                    const products = productsByCategory.get(categoryKey);
                    const categoryHasData = cData.has(categoryKey);
                    if (products.length === 0 && !categoryHasData) return; 
                    products.sort((a, b) => b.sortByValue - a.sortByValue); 

                    const container = document.createElement('div'); container.className = 'py-1';

                    if (categoryHasData) { 
                        const categoryDiv = document.createElement('div'); categoryDiv.className = 'flex items-center p-1 hover:bg-gray-200 rounded';
                        const catKey = `CAT_${type}_${categoryKey}`; 
                        categoryDiv.innerHTML = `<input id="chk-${catKey}" data-key="${categoryKey}" data-type="category" type="checkbox" class="h-4 w-4 text-blue-600"><label for="chk-${catKey}" class="ml-2 text-sm font-bold">${categoryKey} (åˆ†é¡å½™ç¸½)</label>`;
                        
                        categoryDiv.querySelector('input').addEventListener('change', (e) => { 
                            const isChecked = e.target.checked;
                            container.querySelectorAll('input[data-type="product"]').forEach(chk => { chk.checked = isChecked; });
                            if (!isSelectAllBusy) updateSelectAllStates();
                            drawChart();
                        });
                        container.appendChild(categoryDiv);
                    }

                    if (products.length > 0) {
                        const details = document.createElement('details'); details.className = 'pl-4'; 
                        if (['æœå‹™è²»', 'å¯„è³£', 'å–®å¡'].includes(categoryKey)) details.open = true;
                        
                        const summary = document.createElement('summary'); summary.className = 'text-sm text-gray-600 cursor-pointer p-1 rounded'; 
                        summary.textContent = `å±•é–‹/æ‘ºç–Š ${categoryKey} çš„ ${products.length} å€‹å–®å“`;
                        details.appendChild(summary);
                        const productListDiv = document.createElement('div'); productListDiv.className = 'pl-6 pt-1 space-y-1'; 

                        products.forEach(({ id, data }) => {
                            const prodKey = `PROD_${type}_${id}`; 
                            const div = document.createElement('div'); div.className = 'flex items-center';
                            div.innerHTML = `<input id="chk-${prodKey}" data-key="${id}" data-type="product" type="checkbox" class="h-4 w-4 text-blue-600"><label for="chk-${prodKey}" class="ml-2 text-sm truncate" title="${data.name} (${id})">${data.name} (${id})</label>`;
                            
                            div.querySelector('input').addEventListener('change', () => { 
                                const parentCategoryCheckbox = container.querySelector('input[data-type="category"]');
                                if (parentCategoryCheckbox) {
                                    const allProductChks = container.querySelectorAll('input[data-type="product"]');
                                    const allChecked = [...allProductChks].every(chk => chk.checked);
                                    const noneChecked = [...allProductChks].every(chk => !chk.checked);
                                    parentCategoryCheckbox.checked = allChecked;
                                    parentCategoryCheckbox.indeterminate = !allChecked && !noneChecked;
                                }
                                if (!isSelectAllBusy) updateSelectAllStates();
                                drawChart();
                            });
                            productListDiv.appendChild(div);
                        });
                        details.appendChild(productListDiv);
                        container.appendChild(details);
                    }
                    itemSelectionDiv.appendChild(container);
                });
                
                updateSelectAllStates();
                drawChart(); 
            };

            // 3. å…¨é¸åŠŸèƒ½
            const updateSelectAllStates = () => {
                const allCat = itemSelectionDiv.querySelectorAll('input[data-type="category"]');
                const allProd = itemSelectionDiv.querySelectorAll('input[data-type="product"]');
                
                const updateState = (masterChk, items) => {
                    if (items.length === 0) { masterChk.checked = false; masterChk.indeterminate = false; return; }
                    const allChecked = [...items].every(chk => chk.checked);
                    const noneChecked = [...items].every(chk => !chk.checked);
                    masterChk.checked = allChecked;
                    masterChk.indeterminate = !allChecked && !noneChecked;
                };
                
                updateState(selectAllCat, allCat);
                updateState(selectAllProd, allProd);
            };
            
            selectAllCat.addEventListener('change', (e) => {
                isSelectAllBusy = true;
                const isChecked = e.target.checked;
                itemSelectionDiv.querySelectorAll('input[data-type="category"]').forEach(chk => {
                    chk.checked = isChecked;
                });
                isSelectAllBusy = false;
                selectAllCat.indeterminate = false;
                // updateSelectAllStates(); // ç§»é™¤ï¼Œå› ç‚º drawChart æœƒè§¸ç™¼
                drawChart(); 
            });
            
            selectAllProd.addEventListener('change', (e) => {
                isSelectAllBusy = true;
                const isChecked = e.target.checked;
                itemSelectionDiv.querySelectorAll('input[data-type="product"]').forEach(chk => {
                    chk.checked = isChecked; 
                });
                
                itemSelectionDiv.querySelectorAll('input[data-type="category"]').forEach(cChk => {
                    const container = cChk.closest('.py-1');
                    if (container) {
                        const allProductChks = container.querySelectorAll('input[data-type="product"]');
                        if (allProductChks.length > 0) {
                            cChk.checked = isChecked;
                            cChk.indeterminate = false;
                        }
                    }
                });
                isSelectAllBusy = false;
                selectAllProd.indeterminate = false; 
                updateSelectAllStates(); 
                drawChart(); 
            });

            // 4. æ¨¡å¼åˆ‡æ›ç›£è½ (æ•ˆèƒ½å„ªåŒ–)
            [modeAmount, modeQuantity].forEach(radio => radio.addEventListener('change', (e) => {
                // **ä¿®æ­£**ï¼šåˆ‡æ›æ¨¡å¼æ™‚ï¼ŒY è»¸ä¸åŒï¼Œæ’åºåŸºæº–ä¹Ÿä¸åŒï¼Œéœ€è¦é‡å»ºé¸å–®
                populateChartSelection();
                // drawChart(); // populateChartSelection() æœƒè‡ªå‹•å‘¼å«
            }));
            
            // 5. é¦–æ¬¡åŸ·è¡Œ
            populateChartSelection(); 
        }

        // --- Tab 5: ç¹ªè£½ç¸½è¦½åœ–è¡¨ ---
        function drawTotalChart() {
            if (chartInstances.total) chartInstances.total.destroy();

            const labels = allCombinedPeriods;
            if (labels.length === 0) return;

            const salesAmountData = [];
            const invAmountData = [];
            const netAmountData = []; // é€™æ˜¯ **å¯¦éš›æ·¨åˆ©**

            labels.forEach(p => {
                const data = combinedMonthlyTotals.get(p) || { salesAmount: 0, invAmount: 0, netAmount: 0 };
                salesAmountData.push(data.salesAmount);
                invAmountData.push(data.invAmount);
                netAmountData.push(data.netAmount); // å·²åœ¨ updateCombinedData ä¿®æ­£
            });

            const chartCanvas = document.getElementById('sales-chart-total').getContext('2d');
            chartInstances.total = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å…¨ç”¢å“éŠ·å”®ç¸½é¡', data: salesAmountData,
                            borderColor: CHART_COLORS[0], backgroundColor: `${CHART_COLORS[0]}33`,
                            fill: false, tension: 0.1, yAxisID: 'yAmount'
                        },
                        {
                            label: 'å…¨ç”¢å“é€²è²¨ç¸½é¡', data: invAmountData,
                            borderColor: CHART_COLORS[1], backgroundColor: `${CHART_COLORS[1]}33`,
                            fill: false, tension: 0.1, yAxisID: 'yAmount'
                        },
                        {
                            label: 'å…¨ç”¢å“æ·¨åˆ© (å·²è¨ˆç®—å¯„è³£/å–®å¡)', data: netAmountData,
                            borderColor: TOTAL_AMOUNT_COLOR, backgroundColor: `${TOTAL_AMOUNT_COLOR}33`,
                            fill: false, tension: 0.1, yAxisID: 'yAmount',
                            borderDash: [5, 5] // æ·¨åˆ©ç”¨è™›ç·š
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        yAmount: { 
                            type: 'linear', position: 'left',
                            title: { display: true, text: 'ç¸½é‡‘é¡' },
                            beginAtZero: false 
                        },
                        x: { title: { display: true, text: 'æ™‚é–“ (å¹´-æœˆ/å­£)' } }
                    },
                    plugins: {
                        tooltip: { mode: 'index', intersect: false },
                        legend: { position: 'top' },
                        // æ–°å¢ï¼šZoom Plugin è¨­å®š
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                threshold: 5,
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'xy',
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    borderColor: 'rgba(59, 130, 246, 0.5)'
                                }
                            }
                        }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }
        
        // --- Tab 7: åº«å­˜ç›¤é»æ¯”å° ---
        function compareStocktake() {
            // **ä¿®æ­£**: æ¬„ä½åç¨± (é€²éŠ·åº«å­˜ vs å³æ™‚åº«å­˜)
            // åªæœ‰åœ¨ ç³»çµ±åº«å­˜ (combinedData) å’Œ ç›¤é»åº«å­˜ (stocktakeData) éƒ½è¼‰å…¥å¾Œæ‰åŸ·è¡Œ
            if (combinedData.size === 0 || stocktakeData.size === 0) {
                stocktakeResultDiv.classList.add('hidden');
                return;
            }
            
            stocktakeTableBody.innerHTML = '';
            // é¡¯ç¤ºå·®ç•°è¡¨
            stocktakeResultDiv.classList.remove('hidden');
            
            // å»ºç«‹ä¸€å€‹ä»¥ 'å“å' ç‚º key çš„ç³»çµ±åº«å­˜ Map
            const systemStockMap = new Map();
            combinedData.forEach((data, id) => {
                // netData.totalSales = ç¸½é€²éŠ·åº«å­˜
                systemStockMap.set(data.name, data.totalSales); 
            });

            const allProductNames = new Set([...systemStockMap.keys(), ...stocktakeData.keys()]);

            allProductNames.forEach(name => {
                const systemStock = systemStockMap.get(name) || 0;
                const physicalStock = stocktakeData.get(name) || 0;
                const difference = physicalStock - systemStock;

                // å–å¾—ç”¢å“ ID å’Œ é€²è²¨é‡
                const productId = [...salesData.entries()].find(([id, p]) => p.name === name)?.[0] || [...inventoryData.entries()].find(([id, p]) => p.name === name)?.[0];
                const invProduct = inventoryData.get(productId);
                const invTotalQty = invProduct ? invProduct.totalSales : 0; // .totalSales æ˜¯é€²è²¨é‡
                const remarks = getRemarks(name);

                // åˆ¤æ–·æ˜¯å¦ç‚ºç„¡é€²è²¨çš„èˆŠ TCG/å‘¨é‚Š
                const isOldStock = (remarks === 'ç”¢å“ç·š/å¡ç‰Œ' || remarks === 'ç”¢å“ç·š/å‘¨é‚Š') && invTotalQty === 0;
                // åˆ¤æ–·æ˜¯å¦ç‚ºç„¡é€²é …æœå‹™
                const isNonInventory = (remarks === 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)' || remarks === 'å–®å¡/å¯„è³£ (ç„¡é€²é …)');

                // æ±ºå®šè¡Œåº•è‰²
                let rowClass = '';
                if (isOldStock || isNonInventory) { // èˆŠåº«å­˜ æˆ– ç„¡é€²é …æœå‹™ éƒ½æ¨™é»ƒ
                    rowClass = 'bg-yellow-100'; // é»ƒåº• (èˆŠåº«å­˜ / ç„¡é€²é …) å„ªå…ˆ
                } else if (difference === 0) {
                    // æš«ä¸æ¨™ç¶ åº•ï¼Œé¿å…å¤ªå¤šé¡è‰²
                    // rowClass = 'bg-green-100'; // ç¶ åº• (æ­£ç¢º)
                } else {
                    rowClass = 'bg-white'; // ç™½åº• (æœ‰å·®ç•°)
                }

                // æ±ºå®šå·®ç•°æ–‡å­—é¡è‰²
                const diffClass = difference > 0 ? 'stock-diff-pos' : (difference < 0 ? 'stock-diff-neg' : 'text-gray-600');
                
                // **ä¿®æ­£**: åªæœ‰åœ¨æœ‰å·®ç•°ã€æˆ–æ˜¯ç„¡é€²é …/èˆŠåº«å­˜æ™‚æ‰é¡¯ç¤º
                if (difference !== 0 || isOldStock || isNonInventory) {
                    const row = document.createElement('tr');
                    row.className = rowClass; // å¥—ç”¨åº•è‰²
                    // **ä¿®æ­£**: æ¬„ä½åç¨±
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${systemStock.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${physicalStock.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${diffClass}">${difference.toLocaleString()}</td>
                    `;
                    stocktakeTableBody.appendChild(row);
                }
            });
        }


        // --- Tab 6: AI åˆ†æåŠŸèƒ½ ---
        generateAiBtn.addEventListener('click', generateAiInsight);
        
        async function generateAiInsight() {
            if (salesData.size === 0) {
                aiResultDiv.innerHTML = '<p class="text-red-500">è«‹å…ˆä¸Šå‚³éŠ·å”®è³‡æ–™ã€‚</p>';
                return;
            }
            // **æ–°å¢**: AI å¿…é ˆä¾è³´å³æ™‚åº«å­˜
            if (stocktakeData.size === 0) {
                 aiResultDiv.innerHTML = '<p class="text-red-500">AI åˆ†æå¿…é ˆä¾è³´ã€Œå³æ™‚åº«å­˜ã€ï¼Œè«‹å…ˆè‡³ã€Œåº«å­˜ç›¤é»ã€åˆ†é ä¸Šå‚³æ‚¨çš„ç›¤é»æª”æ¡ˆã€‚</p>';
                 switchTab('stocktake'); // è‡ªå‹•åˆ‡æ›åˆ°ç›¤é»åˆ†é 
                 return;
            }
            
            aiLoading.classList.remove('hidden');
            aiResultDiv.innerHTML = '<p class="text-gray-500">æ­£åœ¨æº–å‚™æ‚¨çš„æ•¸æ“šæ‘˜è¦...</p>';
            aiSourcesDiv.innerHTML = '';
            generateAiBtn.disabled = true;

            try {
                // 1. æº–å‚™æ•¸æ“š
                const summary = prepareDataForAI();
                aiResultDiv.innerHTML = '<p class="text-gray-500">æ•¸æ“šæ‘˜è¦å®Œæˆï¼Œæ­£åœ¨å‘¼å« Gemini AI åˆ†æå¸«...</p>';

                // 2. å»ºç«‹æç¤º (å·²æ›´æ–°)
                const userQuery = `
**!! é—œéµåˆ†ææŒ‡ä»¤ !!**
ç•¶åˆ†æã€Œåº«å­˜ç‹€æ…‹ã€æ™‚ï¼ˆä¾‹å¦‚åˆ¤æ–·åº«å­˜éé«˜ã€éä½æˆ–æ¨è–¦æ¸›é‡ï¼‰ï¼Œ**è«‹ä¸€å¾‹ä½¿ç”¨ "å³æ™‚åº«å­˜" æ¬„ä½**ã€‚
"é€²éŠ·åº«å­˜" æ¬„ä½æ˜¯ç³»çµ±è¨ˆç®—å€¼ï¼Œå¯èƒ½å› ã€Œæ¯”è³½çå“ç™¼æ”¾ã€ç­‰æœªè¨˜éŒ„äº‹ä»¶è€Œä¸æº–ç¢ºã€‚
"å³æ™‚åº«å­˜" æ‰æ˜¯æ‰‹å‹•ç›¤é»å¾Œçš„çœŸå¯¦åº«å­˜ã€‚

è«‹æ ¹æ“šä»¥ä¸‹ JSON æ•¸æ“šï¼ˆ**æ­¤æ•¸æ“šç‚ºã€Œé€²éŠ·å­˜å½™ç¸½å ±è¡¨ã€çš„è©³ç´°è³‡æ–™**ï¼‰ï¼Œç‚ºæˆ‘æä¾›ä¸€ä»½è©³ç´°çš„ç‡Ÿé‹åˆ†æå ±å‘Šã€‚

**æ•¸æ“šæ‘˜è¦ (åŒ…å« TCG åº«å­˜):**
${JSON.stringify(summary, null, 2)}

**å ±å‘Šå¿…é ˆåŒ…å«ä»¥ä¸‹ 9 å€‹éƒ¨åˆ†ï¼Œè«‹åš´æ ¼éµå®ˆæ­¤çµæ§‹ï¼š**

1.  **æ•´é«”ç‡Ÿé‹ç¸½è¦½**ï¼š
    * æ ¹æ“š "åˆ†é¡æ·¨åˆ©æ’è¡Œæ¦œ"ï¼Œç°¡è¦ç¸½çµå››å¤§åˆ©æ½¤ä¾†æºï¼ˆå¡ç‰Œã€å‘¨é‚Šã€å–®å¡/å¯„è³£ã€æœå‹™è²»ï¼‰çš„æ•´é«”è¡¨ç¾ï¼Œä¸¦æåŠæ•´é«”çš„ã€Œå³æ™‚åº«å­˜ã€ç‹€æ³ã€‚

2.  **æ ¸å¿ƒç”¢å“ç·šåˆ†æ (ç”¢å“ç·š/å¡ç‰Œ)**ï¼š
    * æ·±å…¥åˆ†ææ‰€æœ‰ã€Œç”¢å“ç·š/å¡ç‰Œã€ï¼ˆå¦‚è£œå……åŒ…ã€é çµ„ã€ç¦®ç›’ï¼‰çš„æ•´é«”æ·¨åˆ©å’Œ**ã€Œå³æ™‚åº«å­˜ã€**ç‹€æ³ã€‚
    * **é‡å°æ¯ä¸€å€‹ä¸»è¦ TCG ç”¢å“ç·š (ä¾‹å¦‚ hOCG, UA, PkM...)**ï¼Œè«‹å¾ "TCGåº«å­˜èˆ‡éŠ·å”®åˆ†æ" åˆ—è¡¨ä¸­ï¼š
        * åˆ—å‡º **3~5 æ¬¾æœ€ç†±éŠ·çš„æ˜æ˜Ÿå–®å“** (ä¾æ·¨åˆ©æˆ–ç¸½éŠ·é‡)ã€‚
        * åˆ—å‡º **3~5 æ¬¾ã€Œå³æ™‚åº«å­˜ã€æœ€é«˜çš„å–®å“**ã€‚
    * **éŠ·å”®é€±æœŸåˆ†æ**ï¼šæ ¹æ“š "éŠ·å”®æ˜ç´°" å’Œ "é€²è²¨æ˜ç´°"ï¼Œåˆ†æç”¢å“çš„éŠ·å”®é€±æœŸã€‚å“ªäº›æ˜¯æŒçºŒç†±è³£ï¼ˆæŒçºŒè£œè²¨ä¸”æŒçºŒéŠ·å”®ï¼‰ï¼Ÿå“ªäº›æ˜¯ç”Ÿå‘½é€±æœŸçŸ­ï¼Ÿ
    * **åº«å­˜å¥åº·åº¦**ï¼šåˆ¤æ–·é«˜ã€Œå³æ™‚åº«å­˜ã€å•†å“æ˜¯å› ç‚ºã€Œè¿‘æœŸé€²è²¨ã€é‚„æ˜¯ã€Œé•·æœŸæ»¯éŠ·ã€ï¼Ÿ

3.  **å‘¨é‚Šç”¢å“ç·šåˆ†æ (ç”¢å“ç·š/å‘¨é‚Š)**ï¼š
    * åˆ†æã€Œç”¢å“ç·š/å‘¨é‚Šã€ï¼ˆå¦‚å¡å¥—ã€å¡ç›’ã€æ¡Œå¢Šï¼‰çš„æ•´é«”æ·¨åˆ©å’Œ**ã€Œå³æ™‚åº«å­˜ã€**ç‹€æ³ã€‚
    * å¦‚æœæ•¸æ“šå……è¶³ï¼Œ**é‡å°æ¯ä¸€å€‹å‘¨é‚Šç”¢å“ç·š (ä¾‹å¦‚ å¡å¥—, å¡ç›’...)**ï¼š
        * åˆ—å‡º **3~5 æ¬¾æœ€ç†±éŠ·çš„æ˜æ˜Ÿå–®å“**ã€‚
        * åˆ—å‡º **3~5 æ¬¾ã€Œå³æ™‚åº«å­˜ã€æœ€é«˜çš„å–®å“**ã€‚
    * åˆ†æå…¶éŠ·å”®æ¨¡å¼ï¼ˆæ˜¯å¸¸é§å“é‚„æ˜¯é€±æœŸæ€§å•†å“ï¼Ÿï¼‰ã€‚

4.  **äºŒç´šå¸‚å ´åˆ†æ (å–®å¡/å¯„è³£)**ï¼š
    * åˆ†æã€Œå–®å¡/å¯„è³£ã€çš„æ•´é«”ç‡Ÿé‹ç‹€æ³ï¼ˆå›ºå®šåˆ©æ½¤ 10%ï¼‰ã€‚
    * **æ·±å…¥åˆ†æ**ï¼šæ ¹æ“š "å„åˆ†é¡æ˜æ˜Ÿå•†å“_ä¾éŠ·å”®é¡" å’Œ "TCGåº«å­˜èˆ‡éŠ·å”®åˆ†æ" ä¸­çš„éŠ·å”®æ•¸æ“šï¼Œæ¨æ¸¬**ä¸åŒ TCG ç”¢å“ç·šï¼ˆhOCG, UA, PkM ç­‰ï¼‰çš„äºŒç´šå¸‚å ´æ´»èºç¨‹åº¦**ã€‚
    * **æ¯æœˆè®ŠåŒ–**ï¼šæ ¹æ“š "éŠ·å”®æ˜ç´°"ï¼Œåˆ†æäºŒç´šå¸‚å ´æ˜¯å¦æœ‰æ˜é¡¯çš„æœˆä»½è®ŠåŒ–è¶¨å‹¢ï¼Ÿ

5.  **ç©å®¶æ´»èºåº¦åˆ†æ (æœå‹™è²»/æ¯”è³½)**ï¼š
    * åˆ†æã€Œæœå‹™è²»/æ¯”è³½ã€çš„æ•´é«”ç‡Ÿé‹ç‹€æ³ï¼ˆå›ºå®šåˆ©æ½¤ 20%ï¼‰ã€‚
    * é€™é …æ”¶å…¥ï¼ˆä¾‹å¦‚æ¯”è³½å ±åè²»ï¼‰ä»£è¡¨äº†**ç©å®¶çš„é»è‘—åº¦èˆ‡æ´»èºåº¦**ã€‚è«‹åˆ†æé€™æ–¹é¢çš„è¶¨å‹¢ï¼Œå®ƒæ˜¯å¦ç©©å®šï¼Ÿæ˜¯å¦èƒ½å¸¶å‹•äººæµé€²è€Œä¿ƒé€²å…¶ä»–ç”¢å“éŠ·å”®ï¼Ÿ

6.  **æŒçºŒç†±è³£å•†å“ï¼ˆå¸¸é§å•†å“ï¼‰**ï¼š
    * åˆ†æ "å¸¸é§ç†±è³£å•†å“" åˆ—è¡¨ï¼Œå®ƒå€‘çš„é‡è¦æ€§æ˜¯ä»€éº¼ï¼Ÿï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦ç‚ºåº—å…§çš„åŸºæœ¬ç›¤ï¼Ÿï¼‰

7.  **å»ºè­°å¢åŠ çš„å•†å“é¡å‹**ï¼š
    * æ ¹æ“šç›®å‰çš„éŠ·å”®å¼·å‹¢å“é …å’Œå¸‚å ´è¶¨å‹¢ï¼ˆè«‹ä½¿ç”¨ Google æœå°‹è¼”åŠ©ï¼‰ï¼Œå»ºè­°æœªä¾†å¯ä»¥è€ƒæ…®å¼•é€²å“ªäº›ç›¸é—œç”¢å“ç·šæˆ–å–®å“ï¼Ÿ

8.  **å»ºè­°æ¸›é‡çš„å•†å“é¡å‹**ï¼š
    * æ ¹æ“šç¬¬ 2 é»å’Œç¬¬ 3 é»åˆ†æå‡ºçš„ã€Œé«˜ **å³æ™‚** åº«å­˜ã€ä¸”ã€Œé•·æœŸæ»¯éŠ·ã€çš„å–®å“ï¼Œå…·é«”å»ºè­°å“ªäº›ç”¢å“æ‡‰è€ƒæ…®æ¸›å°‘é€²è²¨æˆ–ä¿ƒéŠ·å‡ºæ¸…ï¼Ÿï¼ˆ**è«‹æ’é™¤**é‚£äº›ã€Œè¿‘æœŸé€²è²¨ã€çš„å•†å“ï¼‰ã€‚

9.  **ç¶œåˆç­–ç•¥å»ºè­°**ï¼š
    * ç¸½çµä»¥ä¸Šæ‰€æœ‰åˆ†æï¼Œæä¾› 2-3 é»æœ€å„ªå…ˆçš„è¡Œå‹•å»ºè­°ï¼ˆä¾‹å¦‚ï¼šä¸»åŠ›ç”¢å“ç·šçš„æ“ä½œã€é«˜åº«å­˜å“é …çš„è™•ç†ã€ç©å®¶ç¤¾ç¾¤çš„ç¶“ç‡Ÿç­–ç•¥ç­‰ï¼‰ã€‚
`;

                const systemPrompt = `æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„éŠ·å”®åˆ†æå¸«ï¼Œæ‚¨çš„å®¢æˆ¶åœ¨ç¶“ç‡Ÿä¸€å®¶äº¤æ›å¡ç‰‡éŠæˆ²ï¼ˆTCGï¼‰å°ˆè³£åº—ã€‚æ‚¨çš„åˆ†æå¿…é ˆç²¾æº–ã€å°ˆæ¥­ï¼Œä¸¦æä¾›å¯åŸ·è¡Œçš„ç­–ç•¥å»ºè­°ã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä»Šå¤©æ˜¯ ${new Date().toLocaleDateString('zh-TW')}ã€‚`;

                // 3. å‘¼å« Gemini API
                const apiKey = ""; // Canvas æœƒè‡ªå‹•è™•ç†
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                // åŸ·è¡Œ API å‘¼å« (ä½¿ç”¨æŒ‡æ•¸é€€é¿)
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API å‘¼å«å¤±æ•— (${response.status}): ${errorBody}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    aiResultDiv.innerHTML = showdownConverter.makeHtml(text);

                    // è™•ç†å¼•ç”¨ä¾†æº
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attr => attr.web)
                            .filter(web => web && web.uri && web.title);
                        
                        if (sources.length > 0) {
                            aiSourcesDiv.innerHTML = '<h4 class="font-semibold text-sm mb-1">AI åƒè€ƒçš„å¸‚å ´è¶¨å‹¢ä¾†æºï¼š</h4>' +
                                '<ul class="list-disc list-inside">' +
                                sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-600 hover:underline">${s.title}</a></li>`).join('') +
                                '</ul>';
                        }
                    }
                } else {
                     let errorText = 'AI æœªèƒ½ç”¢ç”Ÿæœ‰æ•ˆçš„å›æ‡‰ã€‚';
                    if (candidate && candidate.finishReason) {
                        errorText += ` (Finish Reason: ${candidate.finishReason})`;
                    }
                    if (result.promptFeedback) {
                        errorText += ` (Feedback: ${JSON.stringify(result.promptFeedback)})`;
                    }
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error('AI åˆ†æå¤±æ•—:', error);
                aiResultDiv.innerHTML = `<p class="text-red-500 font-semibold">AI åˆ†æå¤±æ•—</p><p class="text-red-700">${error.message}</p><p class="text-gray-600 mt-2">è«‹æª¢æŸ¥ç€è¦½å™¨çš„é–‹ç™¼äººå“¡å·¥å…· (F12) çš„ Console æ¨™ç±¤æ˜¯å¦æœ‰æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ï¼ˆä¾‹å¦‚ç¶²è·¯é˜»æ“‹æˆ– API é‡‘é‘°å•é¡Œï¼‰ã€‚</p>`;
            } finally {
                aiLoading.classList.add('hidden');
                generateAiBtn.disabled = false;
            }
        }
        
        // æ–°å¢ï¼šæŒ‡æ•¸é€€é¿ Fetch
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 || response.status >= 500) { // é€Ÿç‡é™åˆ¶æˆ–ä¼ºæœå™¨éŒ¯èª¤
                    if (retries > 0) {
                        console.warn(`API è«‹æ±‚å¤±æ•— (Status: ${response.status})ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    } else {
                        throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (Status: ${response.status})`);
                    }
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`API è«‹æ±‚å¤±æ•— (Error: ${error.message})ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error; // æœ€çµ‚å¤±æ•—
                }
            }
        }


        function prepareDataForAI() {
            // 1. åˆ†é¡æ·¨åˆ©æ‘˜è¦ (å·²ä¿®æ­£å¯„è³£/å–®å¡/æœå‹™è²»åˆ©æ½¤)
            const categoryProfitSummary = [...combinedCategoryData.entries()].map(([category, data]) => {
                // **ä¿®æ­£**ï¼šæª¢æŸ¥ å¯„è³£, å–®å¡, æœå‹™è²»
                const isCommission = (category === 'å¯„è³£' || category === 'å–®å¡');
                const isService = (category === 'æœå‹™è²»');
                const salesCategory = salesCategoryData.get(category);
                const totalSalesAmount = salesCategory ? salesCategory.totalAmount : 0;
                
                // **ä¿®æ­£**: æ·¨åˆ© = ä¾åˆ†é¡å€åˆ†
                let profit;
                if (isCommission) {
                    profit = totalSalesAmount * 0.10;
                } else if (isService) {
                    profit = totalSalesAmount * 0.20;
                } else {
                    profit = data.totalAmount; // (ç¸½éŠ·è²¨é¡ - ç¸½é€²è²¨é¡)
                }

                // **æ–°å¢**: ç²å–æ­¤åˆ†é¡çš„å³æ™‚åº«å­˜ç¸½å’Œ
                let categoryRealTimeStock = 0;
                stocktakeData.forEach((quantity, productName) => {
                    // é€é combinedData æŸ¥å“åå°æ‡‰çš„åˆ†é¡
                    const productEntry = [...combinedData.values()].find(p => p.name === productName);
                    if (productEntry && productEntry.category === category) {
                        categoryRealTimeStock += quantity;
                    }
                });
                
                return {
                    åˆ†é¡: category,
                    æ·¨åˆ©: Math.round(profit),
                    é€²éŠ·åº«å­˜: data.totalSales, // (ç¸½é€² - ç¸½éŠ·)
                    å³æ™‚åº«å­˜: categoryRealTimeStock // **æ–°å¢**
                };
            }).sort((a, b) => b.æ·¨åˆ© - a.æ·¨åˆ©);


            // 2. æ˜æ˜Ÿå•†å“ (ä¾éŠ·å”®é¡) - **å¢åŠ åˆ° 10**
            const topProductsByCategory = {};
            [...salesCategoryData.keys()].forEach(category => {
                topProductsByCategory[category] = [...salesData.values()]
                    .filter(p => p.category === category)
                    .sort((a, b) => b.totalAmount - a.totalAmount) // ä¾éŠ·å”®é¡æ’åº
                    .slice(0, 10) // **ä¿®æ­£**: å¢åŠ åˆ° 10
                    .map(p => ({ å“å: p.name, éŠ·å”®é¡: p.totalAmount }));
            });

            // 3. å¸¸é§å•†å“ (åœ¨æ‰€æœ‰éŠ·å”®æœŸé–“éƒ½æœ‰è³£)
            const allSalesPeriodsArray = [...allSalesPeriods];
            const consistentSellers = [...salesData.values()]
                .filter(p => allSalesPeriodsArray.every(period => p.salesByPeriod[period] && p.salesByPeriod[period] > 0))
                .map(p => p.name);
            
            // 4. æ¯æœˆç¸½è¦½ (å·²ä¿®æ­£å¯„è³£/å–®å¡åˆ©æ½¤)
            const monthlyOverview = [...combinedMonthlyTotals.entries()]
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([period, data]) => ({
                    æ™‚é–“: period,
                    éŠ·å”®ç¸½é¡: data.salesAmount,
                    é€²è²¨ç¸½é¡: data.invAmount,
                    æ·¨åˆ©: Math.round(data.netAmount) // é€™æ˜¯å·²ä¿®æ­£çš„æ·¨åˆ©
                }));
            
            // 5. TCG åº«å­˜èˆ‡éŠ·å”®åˆ†æ (åŒ…å«éŠ·å”®/é€²è²¨æ˜ç´°)
            const tcgStockAnalysis = [...combinedData.entries()]
                // **ä¿®æ­£**: åŒ…å« å‘¨é‚Š
                .filter(([id, data]) => {
                     const remarks = getRemarks(data.name);
                     return remarks === 'ç”¢å“ç·š/å¡ç‰Œ' || remarks === 'ç”¢å“ç·š/å‘¨é‚Š';
                })
                .map(([id, data]) => {
                    const s = salesData.get(id) || { totalSales: 0, totalAmount: 0, salesByPeriod: {} };
                    const i = inventoryData.get(id) || { totalSales: 0, totalAmount: 0, salesByPeriod: {} };
                    const category = data.category;
                    const remarks = getRemarks(data.name);

                    const stock = i.totalSales - s.totalSales; // ç¸½é€² - ç¸½éŠ·
                    
                    let profit;
                    if (remarks === 'å–®å¡/å¯„è³£ (ç„¡é€²é …)') {
                        profit = s.totalAmount * 0.10;
                    } else if (remarks === 'æœå‹™è²»/æ¯”è³½ (ç„¡é€²é …)') {
                        profit = s.totalAmount * 0.20;
                    } else {
                        profit = data.totalAmount; // (ç¸½éŠ·è²¨é¡ - ç¸½é€²è²¨é¡)
                    }

                    // **æ–°å¢**: ç²å–å³æ™‚åº«å­˜
                    const realTimeStock = stocktakeData.get(data.name) || 0;

                    return {
                        å“å: data.name,
                        åˆ†é¡: category,
                        å‚™è¨»: remarks, // **æ–°å¢**: å‚™è¨» (å¡ç‰Œ/å‘¨é‚Š)
                        ç¸½éŠ·é‡: s.totalSales,
                        ç¸½é€²é‡: i.totalSales,
                        é€²éŠ·åº«å­˜: stock, 
                        å³æ™‚åº«å­˜: realTimeStock, // **æ–°å¢**
                        æ·¨åˆ©: Math.round(profit),
                        éŠ·å”®æ˜ç´°: s.salesByPeriod, // <-- æ–°å¢
                        é€²è²¨æ˜ç´°: i.salesByPeriod // <-- æ–°å¢ (i.salesByPeriod æ˜¯é€²è²¨é‡)
                    };
                })
                .sort((a, b) => b.æ·¨åˆ© - a.æ·¨åˆ©); // ä¾æ·¨åˆ©æ’åº


            return {
                æ•´é«”ç‡Ÿé‹æœŸé–“: allCombinedPeriods,
                åˆ†æçš„å€‰åº«: warehouseSelect.value || 'æœªé¸æ“‡ (åƒ…éŠ·å”®)',
                åˆ†é¡æ·¨åˆ©æ’è¡Œæ¦œ: categoryProfitSummary,
                å„åˆ†é¡æ˜æ˜Ÿå•†å“_ä¾éŠ·å”®é¡: topProductsByCategory,
                å¸¸é§ç†±è³£å•†å“: consistentSellers,
                æ¯æœˆç‡Ÿé‹ç¸½è¦½: monthlyOverview,
                TCGåº«å­˜èˆ‡éŠ·å”®åˆ†æ: tcgStockAnalysis // **ä¿®æ­£**: å·²åŒ…å«å¡ç‰Œèˆ‡å‘¨é‚Š
            };
        }

        // --- åˆ†é åˆ‡æ› ---
        function switchTab(type) {
            Object.keys(tabs).forEach(key => {
                const isActive = (key === type);
                tabs[key].btn.classList.toggle('active', isActive);
                tabs[key].content.classList.toggle('hidden', !isActive);
            });
        }
        tabs.report.btn.addEventListener('click', () => switchTab('report'));
        tabs.sales.btn.addEventListener('click', () => switchTab('sales'));
        tabs.inv.btn.addEventListener('click', () => switchTab('inv'));
        tabs.net.btn.addEventListener('click', () => switchTab('net'));
        tabs.total.btn.addEventListener('click', () => switchTab('total'));
        tabs.ai.btn.addEventListener('click', () => switchTab('ai'));
        tabs.stocktake.btn.addEventListener('click', () => switchTab('stocktake'));

        // --- åˆå§‹UIè¨­å®š ---
        function initialUISetup() {
            // é è¨­ç¦ç”¨é€²è²¨å’Œé€²éŠ·å­˜åˆ†é 
            tabs.inv.btn.disabled = true;
            tabs.inv.btn.classList.add('text-gray-400', 'cursor-not-allowed');
            tabs.net.btn.disabled = true;
            tabs.net.btn.classList.add('text-gray-400', 'cursor-not-allowed');
            tabs.total.btn.disabled = true; 
            tabs.total.btn.classList.add('text-gray-400', 'cursor-not-allowed');
            // é è¨­ç¦ç”¨ç›¤é»
            tabs.stocktake.btn.disabled = true;
            tabs.stocktake.btn.classList.add('text-gray-400', 'cursor-not-allowed'); 
            
            switchTab('report'); // é è¨­é¡¯ç¤ºå ±è¡¨
        }

        initialUISetup();

    </script>
</body>
</html>
